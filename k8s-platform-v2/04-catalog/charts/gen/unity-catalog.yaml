---
# Source: unitycatalog/templates/server/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: "unity-catalog-unitycatalog-server-config-templates"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
data:
  server.log4j2.properties.template: |-
    status=warn
    appenders=console
    
    appender.console.type=Console
    appender.console.name=Console
    appender.console.layout.type=PatternLayout
    appender.console.layout.pattern=%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n
    
    rootLogger.level=info
    rootLogger.appenderRefs=console
    rootLogger.appenderRef.console.ref=Console
  server.properties.template: |-
    server.env=prod
    
    storage-root.models=file:/tmp/ucroot
  hibernate.properties.template: |-
    hibernate.connection.driver_class=org.h2.Driver
    hibernate.connection.url=jdbc:h2:file:./etc/db/h2db;DB_CLOSE_DELAY=-1
    
    hibernate.hbm2ddl.auto=update
    hibernate.show_sql=false
    hibernate.archive.autodetection=class
    hibernate.use_sql_comments=true
    org.hibernate.SQL=INFO
    org.hibernate.type.descriptor.sql.BasicBinder=TRACE
---
# Source: unitycatalog/templates/server/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: "unity-catalog-unitycatalog-server"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  type: "ClusterIP"
  ports:
    - port: 8080
      targetPort: api
      protocol: TCP
      name: api
  selector:
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
---
# Source: unitycatalog/templates/ui/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: unity-catalog-unitycatalog-ui
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: ui
      protocol: TCP
      name: ui
  selector:
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
---
# Source: unitycatalog/templates/server/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "unity-catalog-unitycatalog-server"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: "unitycatalog"
      app.kubernetes.io/component: "server"
      app.kubernetes.io/instance: "unity-catalog"
  template:
    metadata:
      annotations:
        checksum/serverConfig: "2fd426bf1118d18fba03969d89d96bb8e52f6515349fc090fdd65cb934ae0bee"
        checksum/hibernateConfig: "082a79515c789cde9a8fa18eba0095850e15e39c767594f343a1948ec2f8c258"
        checksum/log4j2Config: "cfdb47e6f174bf079c2cd6a0597aca6ac8ddd338ad8988d191f046c6e4bd23b2"
      labels:
        helm.sh/chart: unitycatalog-0.0.1-pre.1
        app.kubernetes.io/version: "main"
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: "unitycatalog"
        app.kubernetes.io/component: "server"
        app.kubernetes.io/instance: "unity-catalog"
    spec:
      serviceAccountName: "default"
      securityContext:
        fsGroup: 101
      initContainers:
        - name: init
          image: "alpine:latest"
          imagePullPolicy: "IfNotPresent"
          command:
            - /bin/sh
            - -c
            - |-
              apk add --no-cache envsubst openssl curl
              envsubst < /home/unitycatalog/etc/confTemplates/server.properties.template > /home/unitycatalog/etc/conf/server.properties
              envsubst < /home/unitycatalog/etc/confTemplates/server.log4j2.properties.template > /home/unitycatalog/etc/conf/server.log4j2.properties
              envsubst < /home/unitycatalog/etc/confTemplates/hibernate.properties.template > /home/unitycatalog/etc/conf/hibernate.properties

              echo "Generating DER format keys (private_key.der and public_key.der) if they do not exist..."
              if [ -f /home/unitycatalog/etc/conf/private_key.der ] && [ -f /home/unitycatalog/etc/conf/public_key.der ]; then
                echo "DER format keys already exist, skipping generation."
              elif [ -f /home/unitycatalog/etc/confJwtKey/private_key.der ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/private_key.der..."
                cp /home/unitycatalog/etc/confJwtKey/private_key.der /home/unitycatalog/etc/conf/private_key.der
                openssl rsa -pubout -inform DER -outform DER \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.der \
                    -out /home/unitycatalog/etc/conf/public_key.der
              elif [ -f /home/unitycatalog/etc/confJwtKey/private_key.pem ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/private_key.pem..."
                openssl pkcs8 -topk8 -inform PEM -outform DER -nocrypt \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.pem \
                    -out /home/unitycatalog/etc/conf/private_key.der
                openssl rsa -pubout -inform PEM -outform DER \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.pem \
                    -out /home/unitycatalog/etc/conf/public_key.der
              else
                echo "ERROR: No private_key.der or private_key.pem found in /home/unitycatalog/etc/conf or /home/unitycatalog/etc/confJwtKey"
                exit 1
              fi

              echo "Looking up key_id.txt..."
              if [ -f /home/unitycatalog/etc/conf/key_id.txt ]; then
                echo "Key ID file already exists, skipping..."
              elif [ -f /home/unitycatalog/etc/confJwtKey/key_id.txt ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/key_id.txt..."
                cp /home/unitycatalog/etc/confJwtKey/key_id.txt /home/unitycatalog/etc/conf/key_id.txt
              else
                echo "ERROR: No key_id.txt found in /home/unitycatalog/etc/confJwtKey"
                exit 1
              fi

              # Set permissions for the mounted volumes uid:gid 100:101 - unitycatalog:unitycatalog
              chown -R 100:101 /home/unitycatalog/etc/conf
          volumeMounts:
            - name: config-templates
              mountPath: /home/unitycatalog/etc/confTemplates
            - name: config-volume
              mountPath: /home/unitycatalog/etc/conf
            - name: jwt-key-volume
              mountPath: /home/unitycatalog/etc/confJwtKey
          env:
      containers:
        - name: server
          image: "unitycatalog/unitycatalog:main"
          imagePullPolicy: "IfNotPresent"
          ports:
            - name: api
              containerPort: 8080
              protocol: TCP
          startupProbe:
            tcpSocket:
              port: api
            timeoutSeconds: 10
            periodSeconds: 10
            failureThreshold: 30 # 5 minutes

          volumeMounts:
            - name: config-volume
              mountPath: /home/unitycatalog/etc/conf
            - name: db-volume
              mountPath: /home/unitycatalog/etc/db
      volumes:
        - configMap:
            name: "unity-catalog-unitycatalog-server-config-templates"
          name: config-templates
        - name: config-volume
          emptyDir: {}
        - name: jwt-key-volume
          secret:
            secretName: "unity-catalog-unitycatalog-server-jwt-key"
        - name: db-volume
          persistentVolumeClaim:
            claimName: "unity-catalog-unitycatalog-server-db"
  strategy:
    type: Recreate
---
# Source: unitycatalog/templates/ui/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "unity-catalog-unitycatalog-ui"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: "unitycatalog"
      app.kubernetes.io/component: "ui"
      app.kubernetes.io/instance: "unity-catalog"
  template:
    metadata:
      labels:
        helm.sh/chart: unitycatalog-0.0.1-pre.1
        app.kubernetes.io/version: "main"
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: "unitycatalog"
        app.kubernetes.io/component: "ui"
        app.kubernetes.io/instance: "unity-catalog"
    spec:
      serviceAccountName: "default"
      initContainers:
        - name: wait-for-server
          image: "busybox:latest"
          imagePullPolicy: "IfNotPresent"
          command:
            - /bin/sh
            - -c
            - |-
              until nc -z unity-catalog-unitycatalog-server 8080
              do
                echo "Waiting for server (unity-catalog-unitycatalog-server:8080) to be ready..."
                sleep 2
              done
      containers:
        - name: ui
          image: "unitycatalog/unitycatalog-ui:main"
          imagePullPolicy: "IfNotPresent"
          ports:
            - name: ui
              containerPort: 3000
              protocol: TCP
          startupProbe:
            tcpSocket:
              port: ui
            timeoutSeconds: 10
            periodSeconds: 10
            failureThreshold: 30 # 5 minutes

          command:
            - /bin/bash
            - -c
            - |-
              jq '.proxy = null' package.json > temp.json
              mv temp.json package.json
              yarn start
          env:
---
# Source: unitycatalog/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "unity-catalog-unitycatalog"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
spec:
  rules:
    - host: 
      http:
        paths:
          - path: "/api"
            pathType: "Prefix"
            backend:
              service:
                name: "unity-catalog-unitycatalog-server"
                port:
                  name: api
          - path: "/"
            pathType: "Prefix"
            backend:
              service:
                name: "unity-catalog-unitycatalog-ui"
                port:
                  name: ui
---
# Source: unitycatalog/templates/server/keypair-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: "unity-catalog-unitycatalog-server-jwt-key"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/resource-policy: keep
type: Opaque
data:
  
  
  private_key.pem: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS1FJQkFBS0NBZ0VBK3hxcEk3RW1CekRoM3RJRnNNdVN0Tlo3UENZTDZJci9uZzVPUUNQL2I2UE5xWkY4CmdXakl3eGNyUkU5dkFvWmhjWnJzSGlxd201MWlhM0dsSlhOVENLRloxS09GL3FaNUMyZmZZajY5YnQ5SWZnVW0KYTlDQ3Q2SmdETVJpeFUxbmVDZ2pLYk9HNnBxMGtNUkt6QzRaMGoxTnkwb0tRTS9menpBSkxEai94MkhWMTZVWQpCT2dNQjdDK1VQeXFvSklhSCtYVXpSZkVBU1NFenRLcEhnSE40YXZzUjJoMXdLUzJFd1IxcWJ2eHUwQU9uaDd6CmVaUjZUQm11S092ZnIxV2xyVEM2MGV4RzZKUEUwK3FuK2YxdDdvWS93YjZCVEVZTVpRbXJqVUxSdi9lVWRIOFoKeU5PVVdwcndreDB4UWFHQTd1UStVZjhxYzhTMVRaUXNWM1lMbytRQ3owNUQ0eUJJVjdURVVDV2dKejVzU0lMLwpwdFpyWHVlMkUvRDFFSnEwNjNMSTZtdVAzWDNUSG91UlVFUmpVVDVvLzRVSE1yTFp5NkpxV2RTbjBpb3FSbXViCldFNGVSS2NXS1VwSENwNHhjN29SNnJHNGptSDFnUVJMcUtvbk5ZajNvNm96di9WMmNrREhjVk5DaTFLOFRqenoKZEFCNVA5RmdOaUluT28va2JndElkVEJoTmZ3OTQyb3N2MGxmTGxkZkZBRzBPSm8vbFU4R0x6RjJlQnlTUUpCSwpwclNUazRvY1h6TjN3RFRiekhuMi9neGxud2F5RVVTYkF3RVQvZVFLQ2ljNnRIa1hiSEM2ZkQrV2pQRzN5SFNjClNNOGdtRFRtbUlIUFVtVHUvL3RRK05XRUhyeWxCdXFrZFZ0RFE1bUo0SFV0VityaGlrcXlHR2Q4ZWU4Q0F3RUEKQVFLQ0FnQVBqYzIzVDhST3dyamkvL2hwUkpyZ1I3N1hjWFhnWUNmSVJ4T1N4b2dPaHNONUF2R0c1SkkyLzJybgpMdEp1QWh2c0dSQVNLRXZMUDlyMlU5SktlUlBHSDVSOFp1cW9aUEJ2Zys0aTNFY0lwSjBOYlUwOWRXdDdhM3Z1Cm5vV051aWMwR3F4ZTYyZHFoYzIwZit3d0xKVGQ0SDArbitYMXNNcW92MDE2SjBlMHRuczBBZDUwZzFrbmFzdkgKSVhlQ1BicVBpa0Y5dU1DajMzcTRndlVGemsvTjhFUFJBb2YwdUY4czIyUmNjSzlmRFc4NlhTbHd1UUZBVUlEbwp1UCtna1RvVGVjYkF0UldKVjRua0pJOW1IVXdmYjhKb1FtQW85TmZVdEY0amdHV1VzZ1hJbDR6bDB6RkgwWHdnCmFMa0IyenFzMFllSXRia1A5Ym5UUmQvZlJRa2diTmlOVmd5cVgxVEMxVjVkVHRqaUdiS0JWN2VHNWlOOFRJcUQKU1ZJSDBnOUJqZDd0SFduZEwvaGVkOG5KQXl4MzFmWE9zZjc3Qk4zNGVFQ1lQVHFJMlhqSS9HNkdSQkVxWEdsUQpUaE55R1dmV0U5NTJBNmFGMW8zeEJLUUxaUk00bVh4YVhYcEhhQUo5SHNzL2YvSlpOM2xrY2UvWnMvSWRJamltCmtiUEc1Y2huMmg4UFdpODhUdnA1elFEcm91Q2xKNExJRFNtcGNMVTJBM0UwdVhWcnRGbXVld1Z5VWlDenZhL3EKVTkwWmxDZzJ4Zld3bUxzTmMwZTMrc1ZHckVFM3NjRFlBelhlblVVY1l4UEw3MTI4VE9hZitqbzhabEUxRnBKQworbGxsZ2ZhTzdIOEJVNWovTERHV20vZ24zUEMwVFlJcDRocUlPbDNLV2s1NlBsTkw4UUtDQVFFQS8xVUVwam5MCjNWNkpFM3M2LytZQ3V1S1J0Zy9laGtWZk1uVjRuRHIrRFRSemRnM3MvQXpBY1daa2R3TG56c2ljTUFIUklJTUQKRmRyRmZRS1BZYTZpZkR4dUVBV1B4SFJvUkVXSTAwME8yViswaG9zeVBMYUVnN0s1TjU1YUFsbFUrcEJLTDNUUApRYWhZVzE4ditJYUVDL1BWeDVrZWtnd09DYkxzU0JHRXJTMTZ3bHN0NFBIWlF3VE5mcXg4aSthUllYbU1WQ1pICm5PZERXbmF0SkF6anNQUE5rUHNMait5SnR5bGltZnB1Z2NTZHpwckMxaTFJMGN4U1JIc0xJL1VJd21MaGNwTG8KaXIvRkFJaWlIQWdFekovZXgvV0NCNnNFc2NKOFo4NXVpWFF0Sng3VlZacHpLRHA5c0FncGJqZ1M2bWVCSEo1ZApFalN3Z0xzZEVxMEpjUUtDQVFFQSs4TFBzZWlVRDZyRUwySVRWald2THBZNnRrNDk4ZGk0YWpCaEVuM25DTWg2CmNFcnVCdXpjckRoYm1vUHp6Q0JsNHZIQUE5emh0YmVWeVlVbGphR2Vxd1VOK20vL0xOYzArN0tZZm85RmgzYlEKQnArclBSSFdGdWVHZGs5SGxjTGNvaVVrMVZ0WFdWbHRwL1l3Y1FsVkF2UDlCb0M2eU9hRlNNOVMyUFdiREltQgpkTkxUWXhMQms5OVVzd3Z2SWZsaU5WOWNuREx2dkpJaVRXYXFObVMreCtyVDhUaWhRV2hFdXhvVmpmUXB1ODVoCnRRTFdZWGlkOHoxQ2ZEOEhvSmFlN1hkL3VrNlRNcS8yWVVUZFVER2hqTjNYSkwxUUtBQVpCMFByNGp1c1B0eDcKYSsxcGpoVFJzRTM3UGNkSXJCWHRTZndwNm1VRjAxaGxuMmlkd29FSlh3S0NBUUVBMlcyTWlBQ3ZtZExtNTdBSQpqZUZRY2RSK1FJdEM4eFFmL05nTDNQNWZXTjlSY3pab21EcERwazJMUDgwNW1OMDhJNlZvY0VjZ1dYdnlzSUY5Cmw3RWVyS3pKRE51dmtadVBMcFFINytldXZXekNUZEE2OTNoMVg3RFNDSXJRR3kvM0xXZXh4TGV6eGpXVkNEb0cKbjV2czFrRE55eXFZM2NWbUx0d3VXVENSeXVidm9wSUNmNHR6ZDU2Zlh6K0N6NStJTFhsVUJsU1Nwd3BJVU1DKwpyL1JKOEdXc3A4a2dEMjlkMXB0blc3Zm1ZcHNMeHVRREJsK0pveDVhNy9YWGhzY2lybVdGbGd1RCtxTlRIeUU2CjZxUHBjbGF4WDVXeEpOWjlLT0oxRGZDOE1GQytJcElmR01adFNkU0ZNMkcvNWh2Wi84SWtNRHFyQnRYWGQ4ZmUKK2doZ0FRS0NBUUErTXFmYlBTbHZJWElzZnA5bVdnYjRqSGJlMlQrbWd6TTBVTlY2bXc0NzlrT0JnSkdEdG5yaQpOVjQwTTB0RTcvQWIvRHZDK0l2dXQvZFNmUW1GRHh2REJwR29nSWpiVENPejF6Q2plOFBpcnJEQUlpeE0veDRVCk5JamNxOE4wdFZxSzJJQmNFWi9uM0JjaU9zbEc4OVpEejRHQVhNZElvT0xtMVFtVHZrSGEvQkcyaWV0ZGU2SEYKWlpSb1U1ZDFua1hzQjY0NmpMNzdxR0svR3BFTXRTRUpCUFB0a1Y4TmFMUXFRVXgzOEkxcTc1Ym1BRmgwWmpjbgpnOGZzS0NvN08xcnlNZWFsWVlvdUtKakcrUnR3RjRMZzZXR2dtd0Mxa1NpZHllTDUxbUk4ZVg0b2NOUDJIU0NjCjNQY29FUmJjSk9LbHQ1Mm5ZZVBwamRvMVlzUXU3SEFqQW9JQkFRQ3pIVUdrM3Z4MEVTY3lnTnM4MHRBQTB5YmoKdTBCbG5uM2RuMVc4bDUyN2hnZXBQTlNDcExWQzdGOFFreVAzcmJBYWJ1dFZsL2gzY051cStibUV1bi8reXdLNwpvbWJ2dDc0SUdXRVRrUWdWOGozelNUb243Q3F1SlVCRkc4RFc1YS9MS3V5V1J3NVQ0Y3p2aHc5blErRXVTTVR0CldYMVUzeTRRM2lMTHlTL3BDOUgwdjEyeFlHUXNzUXFWaXhjbXNibGprR2ZTUmJKM1BqQkxBdHNMMTNvM0txWjYKaTQrR3EvMTQ4NS9XV0RkUElUWXpVZStZdXdpTXhONUlTTmRFS1psQ3VZUi92UDA1bGFRYTV4SFdCMnVPM0IxUgp3Ti9SYVZGajlRQkVwV2pOZmlwR0FlSnFPSE9SWm9EREdnOEdrOTB0UDJVa2hrcTBCaVFQTGZlY0s4VnIKLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K"
  key_id.txt: "Y2M5ZDQzMDJjYjRhNzBkY2JiM2I1MzEyMzBjOGFlMGJkMTJjNmFlNDMzNmY2ZDMzMmM0NzVhY2NkYmFmODJhZQ=="
---
# Source: unitycatalog/templates/server/db-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "unity-catalog-unitycatalog-server-db"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/resource-policy: "keep"
spec:
  accessModes: 
    - ReadWriteOnce
  resources:
    requests:
      storage: "1Gi"
