---
# Source: unitycatalog/templates/server/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: "unity-catalog-unitycatalog-server-config-templates"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
data:
  server.log4j2.properties.template: |-
    status=warn
    appenders=console
    
    appender.console.type=Console
    appender.console.name=Console
    appender.console.layout.type=PatternLayout
    appender.console.layout.pattern=%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n
    
    rootLogger.level=info
    rootLogger.appenderRefs=console
    rootLogger.appenderRef.console.ref=Console
  server.properties.template: |-
    server.env=prod
    
    storage-root.models=file:/tmp/ucroot
  hibernate.properties.template: |-
    hibernate.connection.driver_class=org.h2.Driver
    hibernate.connection.url=jdbc:h2:file:./etc/db/h2db;DB_CLOSE_DELAY=-1
    
    hibernate.hbm2ddl.auto=update
    hibernate.show_sql=false
    hibernate.archive.autodetection=class
    hibernate.use_sql_comments=true
    org.hibernate.SQL=INFO
    org.hibernate.type.descriptor.sql.BasicBinder=TRACE
---
# Source: unitycatalog/templates/server/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: "unity-catalog-unitycatalog-server"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  type: "ClusterIP"
  ports:
    - port: 8080
      targetPort: api
      protocol: TCP
      name: api
  selector:
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
---
# Source: unitycatalog/templates/ui/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: unity-catalog-unitycatalog-ui
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: ui
      protocol: TCP
      name: ui
  selector:
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
---
# Source: unitycatalog/templates/server/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "unity-catalog-unitycatalog-server"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: "unitycatalog"
      app.kubernetes.io/component: "server"
      app.kubernetes.io/instance: "unity-catalog"
  template:
    metadata:
      annotations:
        checksum/serverConfig: "2fd426bf1118d18fba03969d89d96bb8e52f6515349fc090fdd65cb934ae0bee"
        checksum/hibernateConfig: "082a79515c789cde9a8fa18eba0095850e15e39c767594f343a1948ec2f8c258"
        checksum/log4j2Config: "cfdb47e6f174bf079c2cd6a0597aca6ac8ddd338ad8988d191f046c6e4bd23b2"
      labels:
        helm.sh/chart: unitycatalog-0.0.1-pre.1
        app.kubernetes.io/version: "main"
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: "unitycatalog"
        app.kubernetes.io/component: "server"
        app.kubernetes.io/instance: "unity-catalog"
    spec:
      serviceAccountName: "default"
      securityContext:
        fsGroup: 101
      initContainers:
        - name: init
          image: "alpine:latest"
          imagePullPolicy: "IfNotPresent"
          command:
            - /bin/sh
            - -c
            - |-
              apk add --no-cache envsubst openssl curl
              envsubst < /home/unitycatalog/etc/confTemplates/server.properties.template > /home/unitycatalog/etc/conf/server.properties
              envsubst < /home/unitycatalog/etc/confTemplates/server.log4j2.properties.template > /home/unitycatalog/etc/conf/server.log4j2.properties
              envsubst < /home/unitycatalog/etc/confTemplates/hibernate.properties.template > /home/unitycatalog/etc/conf/hibernate.properties

              echo "Generating DER format keys (private_key.der and public_key.der) if they do not exist..."
              if [ -f /home/unitycatalog/etc/conf/private_key.der ] && [ -f /home/unitycatalog/etc/conf/public_key.der ]; then
                echo "DER format keys already exist, skipping generation."
              elif [ -f /home/unitycatalog/etc/confJwtKey/private_key.der ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/private_key.der..."
                cp /home/unitycatalog/etc/confJwtKey/private_key.der /home/unitycatalog/etc/conf/private_key.der
                openssl rsa -pubout -inform DER -outform DER \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.der \
                    -out /home/unitycatalog/etc/conf/public_key.der
              elif [ -f /home/unitycatalog/etc/confJwtKey/private_key.pem ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/private_key.pem..."
                openssl pkcs8 -topk8 -inform PEM -outform DER -nocrypt \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.pem \
                    -out /home/unitycatalog/etc/conf/private_key.der
                openssl rsa -pubout -inform PEM -outform DER \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.pem \
                    -out /home/unitycatalog/etc/conf/public_key.der
              else
                echo "ERROR: No private_key.der or private_key.pem found in /home/unitycatalog/etc/conf or /home/unitycatalog/etc/confJwtKey"
                exit 1
              fi

              echo "Looking up key_id.txt..."
              if [ -f /home/unitycatalog/etc/conf/key_id.txt ]; then
                echo "Key ID file already exists, skipping..."
              elif [ -f /home/unitycatalog/etc/confJwtKey/key_id.txt ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/key_id.txt..."
                cp /home/unitycatalog/etc/confJwtKey/key_id.txt /home/unitycatalog/etc/conf/key_id.txt
              else
                echo "ERROR: No key_id.txt found in /home/unitycatalog/etc/confJwtKey"
                exit 1
              fi

              # Set permissions for the mounted volumes uid:gid 100:101 - unitycatalog:unitycatalog
              chown -R 100:101 /home/unitycatalog/etc/conf
          volumeMounts:
            - name: config-templates
              mountPath: /home/unitycatalog/etc/confTemplates
            - name: config-volume
              mountPath: /home/unitycatalog/etc/conf
            - name: jwt-key-volume
              mountPath: /home/unitycatalog/etc/confJwtKey
          env:
      containers:
        - name: server
          image: "unitycatalog/unitycatalog:main"
          imagePullPolicy: "IfNotPresent"
          ports:
            - name: api
              containerPort: 8080
              protocol: TCP
          startupProbe:
            tcpSocket:
              port: api
            timeoutSeconds: 10
            periodSeconds: 10
            failureThreshold: 30 # 5 minutes

          volumeMounts:
            - name: config-volume
              mountPath: /home/unitycatalog/etc/conf
            - name: db-volume
              mountPath: /home/unitycatalog/etc/db
      volumes:
        - configMap:
            name: "unity-catalog-unitycatalog-server-config-templates"
          name: config-templates
        - name: config-volume
          emptyDir: {}
        - name: jwt-key-volume
          secret:
            secretName: "unity-catalog-unitycatalog-server-jwt-key"
        - name: db-volume
          persistentVolumeClaim:
            claimName: "unity-catalog-unitycatalog-server-db"
  strategy:
    type: Recreate
---
# Source: unitycatalog/templates/ui/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "unity-catalog-unitycatalog-ui"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: "unitycatalog"
      app.kubernetes.io/component: "ui"
      app.kubernetes.io/instance: "unity-catalog"
  template:
    metadata:
      labels:
        helm.sh/chart: unitycatalog-0.0.1-pre.1
        app.kubernetes.io/version: "main"
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: "unitycatalog"
        app.kubernetes.io/component: "ui"
        app.kubernetes.io/instance: "unity-catalog"
    spec:
      serviceAccountName: "default"
      initContainers:
        - name: wait-for-server
          image: "busybox:latest"
          imagePullPolicy: "IfNotPresent"
          command:
            - /bin/sh
            - -c
            - |-
              until nc -z unity-catalog-unitycatalog-server 8080
              do
                echo "Waiting for server (unity-catalog-unitycatalog-server:8080) to be ready..."
                sleep 2
              done
      containers:
        - name: ui
          image: "unitycatalog/unitycatalog-ui:main"
          imagePullPolicy: "IfNotPresent"
          ports:
            - name: ui
              containerPort: 3000
              protocol: TCP
          startupProbe:
            tcpSocket:
              port: ui
            timeoutSeconds: 10
            periodSeconds: 10
            failureThreshold: 30 # 5 minutes

          command:
            - /bin/bash
            - -c
            - |-
              jq '.proxy = null' package.json > temp.json
              mv temp.json package.json
              yarn start
          env:
---
# Source: unitycatalog/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "unity-catalog-unitycatalog"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
spec:
  rules:
    - host: 
      http:
        paths:
          - path: "/api"
            pathType: "Prefix"
            backend:
              service:
                name: "unity-catalog-unitycatalog-server"
                port:
                  name: api
          - path: "/"
            pathType: "Prefix"
            backend:
              service:
                name: "unity-catalog-unitycatalog-ui"
                port:
                  name: ui
---
# Source: unitycatalog/templates/server/keypair-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: "unity-catalog-unitycatalog-server-jwt-key"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/resource-policy: keep
type: Opaque
data:
  
  
  private_key.pem: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKSndJQkFBS0NBZ0VBdmJFdVkzbWpVRzZvVEI3YmFDT2hHK1VDaFdCRTFyNGZpaGgyTWpsZXNnK2E4cm51Cm16NXZYSk1TeTViWHN5c1Q3aGhHeDk2eTBya3o4cFk5L3IzQzZ0T0pMUVgrQU01RGRaa0h6MjJoK1ljQkRKc2cKNzVSWTN5OXV5VmNiZjVXa3B4TEpFb2VVV0NGci81Sy9mbTMweTZSeTZ3eVB1Um80N1d3eHFUcUszUFhzNFlUSwpQbUFKUEJEa1hYZkRJeFRQTWV3Ukl3MUFxbWpyRGgyNFh0VytrT204eXFlS0VtK1VCbWxCV3RKeWxYYURORE1rCkVKS1U1ck1QTE05NTRQN2EzMVVsUVZRTExPSVdoYzJsSktLbTV0VnZQZGtuNjIydW5sbzZ1MTBVcDJCOTc2eDgKRVp3MG93MjFMKzRBckx1TUo5Q3pvNFRCSHd3NlFHREJLZmR4SGdrcVlPNWtDNWg5Zm1BY2JNMWptcVNDc2lWMgo5aXR5dWJhMmJWSXNRcnNVYitxbU9yRjJDalVMUHhDTFBxSTBsaVp2ckQ4TEdpMHBMOGpZTytFQmIxdlFIRVVnClVLM2ZyNmxmNVVzMk9VcGdmVzFBWWMwRy9yaTRhNG15TTF4MjF6K1BuY0I3L3VZSUZjcFcySC9vTTViSmdBU2oKNWhtRG0zR2E0TS9SR3JtK1RFZ0k3L2w3ZzFhSWp5eXVqZHdhODdCYlFvTnRmZEtrdGRrZjNSbjdFSllhWTJVTAp4OE5LTnZ5cU5JZ3JpZ0NZT0RhZU4wTjV1aXlmNC8xTjBXMG1Eb1YyZ0RYVWdtNmRyWDlhOGxydVo2MkEzcDN5CnhpTkQyYnNIYzF6bUFaYlVPajJxZUovSFE2dk0zdjR6TjJmS1JYMkNrYjhzNGN5b0UrSTJpaDQ2dW5FQ0F3RUEKQVFLQ0FnQUlONitBaFljTUVqWE9FYmZPdFFmQzhnSzZzcG13MVlJcUdrRlpPaVV1ZGd0djhKcnBWSnBWbFQvUgp4dHBYeTVTSFhUdXpFZzd4bnRrbEFtOWVSSUZpazdZNWdpMEhneEttNVhHbmx3S0Jab3VSVjFGbE1qK1ZCWlNaClQzY2thYlZudTh6Wm9HVjVCRDVONUtFbWtlUUhycnRWWlpFcFdKS01ReTBMUFhzV3M1R201YmpaaHhGY3JkejkKYVVBd2IzT1lDdmU2d0JWNUp4RTl1K1JlT1Y0U0lEUzZtNzVEdjdFc0xrTHpuZ2ZJT1VtRVNVM2Y2T3NKNjhwZwphMzdidnN2NUNQMStRbXpoMkNFdEpvN25xQ011VktNeHpQYVVLMGQ1V29QT1ZPdmRqTFRQOHFDRSs4ZkhvNEwzClRWVWFwb2VkdkVaaW5hV1J4SUZyMkxVdGcxSm9yVHpSaUJ2NXdseS9wd1U2blNKMWUxdWxFVGhpQ3pRZWdIYVMKUXcvL1I5SE50Ky84Y2tpbnd4VzdpeVArbUhXVXRHbGJCZ3k3amp2anBsRWxKTHgyU3dsblhDYkdOcVE2cTQyKwpzWU1WbE9oR1UrS203NmpBWmpHQWhVMUdhUDNESEh6VUQ5Q1Fud1o4NERscXp1MGZpM0hCWTRnUDN1Sks1TFR2CjlNazV4M3VaMGlFL1pSajBLSWl3enpUQzFGR0srWUVMZSs5MlRETnRWakI2L2FON2xYYnJiK3F5SDBRdU45MHAKR2p6aGo2MThPeUZIRGRjUkdkbmpWVHg1NVJmQWVFNndyczd4YkJKbU4yMUFVL0FhRTlSV3RWREFRK1VOTW1DOQpmY3dxbUNxN0ZJRWVsV2NLT2c0QzZXY3BDYWNVcmpTYmhTd0NJRTFGbnd2VlFJaitwUUtDQVFFQTlhWXk2QklxCnpNd21RZElEZzk2L0NOM2VhTllLOFBnUFhvTXVwYTQ3TVlyd3lwUzZ0SEZOVTBucHVCbHRlNFRPZFRDb3NVSWkKWGNwMC9NS2pZczVaL3VXNWVYZWVQMERRbWFrT0xncXNPMk9sU2U1djZlb1BhVUVxVjVKOEpjRURLY0UxZ2czZwpXQW5ubEtieDJTVDJ1emFBbXptVnhKR2xlZ3BWdVNYSkhhc2dpZkFMLzFKWkY1ZWF3Snl4NGhyOEpwNUxJQjBJCmltbWtVaStoZXk3ZzBnaVZSSGlWOTY0c21WWUpHcFh5eS9VT1RRYzVKeUEyU3VHbHdSVk9udHZwZE0waG91d2MKb0w0R1R5MDdWOVRJWlFwSjFaR0oxeXErVlJFcVhJa2xDY2FlT0JUbEFvMlBPakl6OEdUR3BUUUZoN1FrTVZ1cAo0V3FKNFdod0NzcU0zUUtDQVFFQXhhOWdnUHI1UVB6MU9RT2phQkNrREx4UXlzd1orelBtcXhiK2FtZUgrblBNCnZXZHJldnY0NERVd3NCUXZMQ2YwVEJBQTdNZE1RZGlEd29tT3k1MnZLYllhcTIwWGdWUVprRTNoK3BLS0IvVzQKNHgwSC9RRkRMR1lNN0NQdlBzOWVDNVBTaE0rNEZWbkhqK25OVzVyS3BzQ3RJc2xlaCt2cXZhN3FkOTBRYlpTZQp1ZHhQSXJhZVhRTHhXY1EwYVR4c0NJdWZOZ1lWb0kvZXNzVWRpNSswaWRPenRRa0xDbXhWcFZZcjQxa0hreG5wCkp3d2hHODRsMVozRDdHd3FvT0EyUkdXdXg3aVVUT3lXeVJKMzFxai9vTm96Vnhlc0VKWmYrS3liQmNuc243QmoKbDMrejFUbU8xWmlnbWhqS2V5V0hxRFJGQXkyckdSdkhBU1c0Vzg2d3BRS0NBUUI0ZnJ6THoxV0ZQY0txV0t6Mgp1NFZ6Z1BsKzdUZFN1aXMzemh0TWsrbGZST3NXUTl4TmRLSmNiNDRnaXdDRUxVSGtoQ2pMUWtoL1B6Y2hZUXdxCkJGUnF6eDZxc1gxRFE3VFBHdmprcHNHVEpDN0kxQmU3WXQrS1hyZTVXeFpnb291OXFKTnBwd3JieElmL0IrRHMKQmRDdFJtL1JORzc5aS8vaW5EMHVZNVdDWXhYRDg2YSs2QkxobXJFRE9CbWRjbVVyUUV4VGhVcFNNcjJ5dnNCMApIeXVTZXpsVTY5Mk1MN2lhd25RV3dXVG1uTjhWODZ3YVFCZkJwV3ZjQ1dxV1RBTDVFMElqbTdQek9TTDVKWlBOCllvZWw0R1VWU0oyWG1OVGgvMWlMS1k2c2UrdlNVSldCS2hVT2s5K2NWS0tJR0x0NXRHaG9lYkViN0ZtVDR0bksKd1U1VkFvSUJBSGRSdk5qOUkxZHpsM3diVXhVci9pamx2WW82bVhBRFNyWjRBWVl1Q1doRlh3M3ZqM05EQlZ3bgpIc1VZMmNRNE5YOTNwV2RGZ0NTNlVBVXF6RExnY1dxbXpRQXRyNk5USkw3eUUzVVA0QnFmMlVIVU13OG1KT3AyCmlsUTUrRjBjQXpMUHZhQ0dWQ0VtK0lwSDM3anIvR2VjSXFTOWtMNVB5bmRGVGFhZG14M1pOOWtOUGdMQTRXTlkKdEY2dlM4YzlQaVFHU2tuc2NEOWl0MU9HSUtnMjlGekFtRmFzSjZyWjZ2UUp5Q0hJaWdiaSs5U2l3SlVzMzY5SgpNNG5QWEFlUWJaRHBJdzdQdlV1VS9ncE5pR0hiemJmRUhIcjBBZHBkT1g0NmlMTjh4c000VDFTUk12Vi9jVlJCCmRLYXVVZ0QwalNZY3JvOFZrSkZ1TDdia2twdHZiVFVDZ2dFQVBNRzk4c05mUkdoT3ZCa1g4cXZzL0tYa3FORk0KK0E1RkpXOFBIeVMzVXJNeGNxeVBYNzJBVUJIOE85enZGRW9UVjBFTmxMQlhSODBtbUp2WGVIUXpZY1RVay9ZVwowUG1qWTJnVGhNVmNYRjZ4Nk03VHhqcVc5alVhRDdyaHp6U0tuQVpMeVJ4WXdQTnVIOUFwM3Vhc1JJLzdHbkNUClNVSWZHekNOaEtpVmFzbFlNNTJPc0dnM2F5ZStIRENCNCtDK0RDcFFYRUErUVczT3NteFYxVEFOaU5WSlBXQk0KQXZMaTRmWDRKQUlDQUxyZHFwZnRFQjV2UlFrYi8rVjlIOGNkK0JMTUdQK1pnZVgwREE3azVsRmpxNlFENFBzRQp6NjBXT2xwV24zSVN3V0Z2WWF1ck01ZGNueTEwWE44NVIwY3ZzMExHQmNtUDZHUVlmdkk3UVRvMU9nPT0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K"
  key_id.txt: "NzUxYmNhYThmMWZlZTQzMzk3MGYzMGExMTJlMDZlYjI2NDc1MWY4MTFlNTRmOGRlNGZiNmQzZWNlNWViZDc0ZQ=="
---
# Source: unitycatalog/templates/server/db-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "unity-catalog-unitycatalog-server-db"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/resource-policy: "keep"
spec:
  accessModes: 
    - ReadWriteOnce
  resources:
    requests:
      storage: "1Gi"
