---
# Source: unitycatalog/templates/server/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: "unity-catalog-unitycatalog-server-config-templates"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
data:
  server.log4j2.properties.template: |-
    status=warn
    appenders=console
    
    appender.console.type=Console
    appender.console.name=Console
    appender.console.layout.type=PatternLayout
    appender.console.layout.pattern=%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n
    
    rootLogger.level=info
    rootLogger.appenderRefs=console
    rootLogger.appenderRef.console.ref=Console
  server.properties.template: |-
    server.env=prod
    
    storage-root.models=file:/tmp/ucroot
  hibernate.properties.template: |-
    hibernate.connection.driver_class=org.h2.Driver
    hibernate.connection.url=jdbc:h2:file:./etc/db/h2db;DB_CLOSE_DELAY=-1
    
    hibernate.hbm2ddl.auto=update
    hibernate.show_sql=false
    hibernate.archive.autodetection=class
    hibernate.use_sql_comments=true
    org.hibernate.SQL=INFO
    org.hibernate.type.descriptor.sql.BasicBinder=TRACE
---
# Source: unitycatalog/templates/server/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: "unity-catalog-unitycatalog-server"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  type: "ClusterIP"
  ports:
    - port: 8080
      targetPort: api
      protocol: TCP
      name: api
  selector:
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
---
# Source: unitycatalog/templates/ui/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: unity-catalog-unitycatalog-ui
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  type: ClusterIP
  ports:
    - port: 3000
      targetPort: ui
      protocol: TCP
      name: ui
  selector:
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
---
# Source: unitycatalog/templates/server/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "unity-catalog-unitycatalog-server"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: "unitycatalog"
      app.kubernetes.io/component: "server"
      app.kubernetes.io/instance: "unity-catalog"
  template:
    metadata:
      annotations:
        checksum/serverConfig: "2fd426bf1118d18fba03969d89d96bb8e52f6515349fc090fdd65cb934ae0bee"
        checksum/hibernateConfig: "082a79515c789cde9a8fa18eba0095850e15e39c767594f343a1948ec2f8c258"
        checksum/log4j2Config: "cfdb47e6f174bf079c2cd6a0597aca6ac8ddd338ad8988d191f046c6e4bd23b2"
      labels:
        helm.sh/chart: unitycatalog-0.0.1-pre.1
        app.kubernetes.io/version: "main"
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: "unitycatalog"
        app.kubernetes.io/component: "server"
        app.kubernetes.io/instance: "unity-catalog"
    spec:
      serviceAccountName: "default"
      securityContext:
        fsGroup: 101
      initContainers:
        - name: init
          image: "alpine:latest"
          imagePullPolicy: "IfNotPresent"
          command:
            - /bin/sh
            - -c
            - |-
              apk add --no-cache envsubst openssl curl
              envsubst < /home/unitycatalog/etc/confTemplates/server.properties.template > /home/unitycatalog/etc/conf/server.properties
              envsubst < /home/unitycatalog/etc/confTemplates/server.log4j2.properties.template > /home/unitycatalog/etc/conf/server.log4j2.properties
              envsubst < /home/unitycatalog/etc/confTemplates/hibernate.properties.template > /home/unitycatalog/etc/conf/hibernate.properties

              echo "Generating DER format keys (private_key.der and public_key.der) if they do not exist..."
              if [ -f /home/unitycatalog/etc/conf/private_key.der ] && [ -f /home/unitycatalog/etc/conf/public_key.der ]; then
                echo "DER format keys already exist, skipping generation."
              elif [ -f /home/unitycatalog/etc/confJwtKey/private_key.der ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/private_key.der..."
                cp /home/unitycatalog/etc/confJwtKey/private_key.der /home/unitycatalog/etc/conf/private_key.der
                openssl rsa -pubout -inform DER -outform DER \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.der \
                    -out /home/unitycatalog/etc/conf/public_key.der
              elif [ -f /home/unitycatalog/etc/confJwtKey/private_key.pem ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/private_key.pem..."
                openssl pkcs8 -topk8 -inform PEM -outform DER -nocrypt \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.pem \
                    -out /home/unitycatalog/etc/conf/private_key.der
                openssl rsa -pubout -inform PEM -outform DER \
                    -in /home/unitycatalog/etc/confJwtKey/private_key.pem \
                    -out /home/unitycatalog/etc/conf/public_key.der
              else
                echo "ERROR: No private_key.der or private_key.pem found in /home/unitycatalog/etc/conf or /home/unitycatalog/etc/confJwtKey"
                exit 1
              fi

              echo "Looking up key_id.txt..."
              if [ -f /home/unitycatalog/etc/conf/key_id.txt ]; then
                echo "Key ID file already exists, skipping..."
              elif [ -f /home/unitycatalog/etc/confJwtKey/key_id.txt ]; then
                echo "Using /home/unitycatalog/etc/confJwtKey/key_id.txt..."
                cp /home/unitycatalog/etc/confJwtKey/key_id.txt /home/unitycatalog/etc/conf/key_id.txt
              else
                echo "ERROR: No key_id.txt found in /home/unitycatalog/etc/confJwtKey"
                exit 1
              fi

              # Set permissions for the mounted volumes uid:gid 100:101 - unitycatalog:unitycatalog
              chown -R 100:101 /home/unitycatalog/etc/conf
          volumeMounts:
            - name: config-templates
              mountPath: /home/unitycatalog/etc/confTemplates
            - name: config-volume
              mountPath: /home/unitycatalog/etc/conf
            - name: jwt-key-volume
              mountPath: /home/unitycatalog/etc/confJwtKey
          env:
      containers:
        - name: server
          image: "unitycatalog/unitycatalog:main"
          imagePullPolicy: "IfNotPresent"
          ports:
            - name: api
              containerPort: 8080
              protocol: TCP
          startupProbe:
            tcpSocket:
              port: api
            timeoutSeconds: 10
            periodSeconds: 10
            failureThreshold: 30 # 5 minutes

          volumeMounts:
            - name: config-volume
              mountPath: /home/unitycatalog/etc/conf
            - name: db-volume
              mountPath: /home/unitycatalog/etc/db
      volumes:
        - configMap:
            name: "unity-catalog-unitycatalog-server-config-templates"
          name: config-templates
        - name: config-volume
          emptyDir: {}
        - name: jwt-key-volume
          secret:
            secretName: "unity-catalog-unitycatalog-server-jwt-key"
        - name: db-volume
          persistentVolumeClaim:
            claimName: "unity-catalog-unitycatalog-server-db"
  strategy:
    type: Recreate
---
# Source: unitycatalog/templates/ui/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "unity-catalog-unitycatalog-ui"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "ui"
    app.kubernetes.io/instance: "unity-catalog"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: "unitycatalog"
      app.kubernetes.io/component: "ui"
      app.kubernetes.io/instance: "unity-catalog"
  template:
    metadata:
      labels:
        helm.sh/chart: unitycatalog-0.0.1-pre.1
        app.kubernetes.io/version: "main"
        app.kubernetes.io/managed-by: "Helm"
        app.kubernetes.io/name: "unitycatalog"
        app.kubernetes.io/component: "ui"
        app.kubernetes.io/instance: "unity-catalog"
    spec:
      serviceAccountName: "default"
      initContainers:
        - name: wait-for-server
          image: "busybox:latest"
          imagePullPolicy: "IfNotPresent"
          command:
            - /bin/sh
            - -c
            - |-
              until nc -z unity-catalog-unitycatalog-server 8080
              do
                echo "Waiting for server (unity-catalog-unitycatalog-server:8080) to be ready..."
                sleep 2
              done
      containers:
        - name: ui
          image: "unitycatalog/unitycatalog-ui:main"
          imagePullPolicy: "IfNotPresent"
          ports:
            - name: ui
              containerPort: 3000
              protocol: TCP
          startupProbe:
            tcpSocket:
              port: ui
            timeoutSeconds: 10
            periodSeconds: 10
            failureThreshold: 30 # 5 minutes

          command:
            - /bin/bash
            - -c
            - |-
              jq '.proxy = null' package.json > temp.json
              mv temp.json package.json
              yarn start
          env:
---
# Source: unitycatalog/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "unity-catalog-unitycatalog"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
spec:
  rules:
    - host: 
      http:
        paths:
          - path: "/api"
            pathType: "Prefix"
            backend:
              service:
                name: "unity-catalog-unitycatalog-server"
                port:
                  name: api
          - path: "/"
            pathType: "Prefix"
            backend:
              service:
                name: "unity-catalog-unitycatalog-ui"
                port:
                  name: ui
---
# Source: unitycatalog/templates/server/keypair-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: "unity-catalog-unitycatalog-server-jwt-key"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/resource-policy: keep
type: Opaque
data:
  
  
  private_key.pem: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS1FJQkFBS0NBZ0VBN05hNUlPUG03a2hhc25HUTZBV1dVeklScnNQR3I1bjEyOHF6SDcycjRrTEZYcG5DCnZoRWZTTUNtY1N5Q1FVeVJHRHBZWVpTRldWTUxFTXY2Q2FOS1J6QUJkaWNnckVNMlA1UW9BcVBkK1hsSi9BR3cKUGxYOFlqQ1NYMk82Z3dHYnhBa0ZuaFVpZmZLN2UvNWZKUVBIUmxMcjVCTk83bUVFcFYrTUtMZkRGNnUrb3hxbgpzdVBlU1NZZjNOTnVsS01KaS96TjhpVm40KzJqNlJ6WW5MVTdiOVV0d1Areldod2YrN3VxdFAvOVE0V1FydGpQClN0ejl2WThwRDRoY3lKWTdEaTVMenh1d1Q2dEtZRCt5dzVlRW1lVEFSTVBHZi92OHc2WkVBVVR4V2lHSit6ZFgKd3AwTzlsbUhIWkxCZzZuUzNLaFR3c0I3aXQwTDdaR0dyTDVYNWxLOTBnNjVMSVNHNldwYXVaSXdwblNTSkx1ZApzeEtpU2tzUGkrOEdKTUUwNkJyWkZ3V2tlb0RuRGduaXg4OWFRa3RmQTlYZUhLZkFjT0hHTmtSK0s1ekZaeWVDClBUOTBxZkpud3cvZHNmRUZWQ1ZVaFFzc2xDZkdkcm1KZElRWmhnQ1ViNlJmK0ZCdTRzc0h4Q0ZNQ0NsMVFYV2oKTitGdm1PdUppNmhjbUdtRC84UkhwVG9iVEg2Y1ZwN2U3MzJ3NEl4T2Z4NVNLQzh6ZnJCenJ5Yml2RGdhNUNxSQphaVFzNDNXbTVEQU1tbVVpZ3FYTWNQc1ZHUUpEMjUvOXczdkhSNnFWVXcxeE84ejNSUmE2WFBPK1R0SVVCMUZhCkFFZ0RqWXhXZms2VUdNTXF1amVPWUpkMDdlMUhYT3lYK2RaeThqVTFqQVM4enBOVUsvY29MQzg3UUZFQ0F3RUEKQVFLQ0FnQUF3NnFpU0FvQlA5dUhFdVhBVWZCTHdYQWNLOGFTMzREVEhrTFl1ZUI1b1BTSkd4N3RSUm5nUHJycQp4NVYrQjNTNmFzbkpPdFQ1VmxMRlVac3pkOEx3R3VBT1ZRNytiMU1YL203b24wWENuZGtXeHB5ZWZ1R0xJWlAvCldjK0t4N0VNZjJqMHV5VzYyVk13a2NBVjJ2N0VJOVZlRFkvbUpnc0JTNThrckg4bEx1azFGb3R2QU54QlNTMjIKSlRxSW9VUVJIeFk5RDFEWUEvYlE5RVpncnhjTGc5a2JjOWZNMVNWblJ4SkVka1VIZUVGZ3h4TllMd0Zrb0xjbAp0Uzl6ZUVTbGhaRzZEK0ZRU0lHN2NNa3ZaMmhHcE4zWCt2ZkRodmtvV251Q3M0bkIzRFRaU2pMdXpsbnpncE4wCmpYb3haaFZubitWeFRmUzRISUdDMlVMaGdOWEF4M0dLVGRPdVB6SEtrR0ZaT0hFV1ViWk9ZblpGaHRQcHM3UDgKT3VKcXcyVncxUWlzd0hzTUlTMWpPYkNtQVhZUENKK3MyelpFRlBXaEVhVlZUV1EzZ3duMGNmb2Q0Z1ZuVk41MwpHc3Yvelg4akJ3Y2syZjdrOGoxczlDL291RGZFdGlhdGJuQVJCb1l6cEJTSTZtNFFTb1JZT1JtRVBRMHMyQTQ1Ck9ScnY3STdyWW1tMElBQW9Gb1kxdEZOeWtxK1MzQldwc2FibHJxVzBhQ2tSU3BCRjJORks1ako4dUlaMnJOVTIKTUNCdlJiTGxNMm5wbTZiVm92UGlBRFJ2NFlVbWJuV25zdkJiS2hhVldMY05OU3FWdHE2QmVCaWxuK1ZzL2lkWQpWbnYvZmxINHlvUi9ueU1YcSttMVZ3OUhhS09LQXBUTnpJbEdYVTB6UVVuZnBiZXE5d0tDQVFFQS9aNW5pdEVBCllYZFJLNit6bStpa1FKYVBRenNkKzlTYWNXR2tvMDlQb0xUeVk0Yzd0Z1ZpSGpzb2lGTXdIcFAzelJTbDFydEwKaDJtdFhkU0liMzNVczR6NHhYcTZabDFWb2ZjNjJGNVhOTFdBbE9PWEsraU1XaUE4bjNzUG15UkhQRlN5MDE4SAo1RXdyUHhCZWtQVTNwQVc5YkZnTnpPK3Q1Q2lGYzNTcUpxbFpET2I0YU1XRlplYWttWUpMWFNhUFF3T2x4ckZlCnZlc0tQb0s4MXNSQnIzWlVsNzFRM1A3VUpaeG81d21aTS9ab1oyZ0NPQnFFUjJaS2lnZHcvUFFmZkdmMUFhVmMKQnkwSUpIKzBmM3pXOGFRTS9lUTRmc3dZOEhZT0hhdVMvNmZ2aHU0eUIrY2JvZU5QenhTZm9kM3ZhKzQwNUVRTApZR1ZvbDJqWEFwblFHd0tDQVFFQTd3LzhoNDZEYitBVGY0Zk11TWladndiM01DMVdvaEtrMFByWVVzeHc0N3VaCkpxc1VuZTkwR3FHNTFuRVlkelBXcmRrNEFXaXFIdCtCTnpPMWJYMGd2UlMrV2hZMG5EbG1JK2FVQU9kVUZWbDcKQVdmL1FRSzlNM3BxL0pFNi8xMXMyL3gxM2xJVW4raHE4ejQxeTZ4OFRQelhueGZyRG8xYjdCQXgvUWlUZkltZgpxQ1FiN1hCTW9JVUFwMTh2S1hEWURmU1N3Z2g2RzNzNTUyR1NpRk05VEk4ZHp0aURMRlB4NTNwckkvSXVhNnlHCnprcjg1L2Mwd3JXdUI0TTY4Y2FCbmdqZEJraHJwRFE2S2dmcUtFQm5OcmMxZ3lGajRDYy8zRGxwdllON0Z4SVcKOVVTZ3g1UWE2WDVmdEJCbkE1KzVhVWJoVG1Dc3RzbkhCTS9BTDBad0F3S0NBUUVBZ2tGbjFtRFBQRCttbmJSSQpuOHRWQ0tNTEF6R0tqYnM4Y3Z6K0xLM2dMSjZpV3NHcXhpcHZvUzBxL1JFVWhxL2lOaDdqcWF4Wjl6c3NRaU9VCnl3WXFSdWtoSDNPUDVtRUxTUHNMNnZKUkFZNHljc1dNNzQwcEFHVE1IZkI3TEdmdWVpcmFDVHNtZDNjelF0bHEKYURLNUYvR212czFla1NHTUFzRlpBTm9yUlYzMmtXelNxaVRBQlh6MmpxemZmZ0QrMVNFN2RCZkdtKzNxUGY2eApjL0FwK0M3aTlXZlM3eDJsNFljNlRXYWRtNVZ6TzZDc2V4b0xWQXhTUGgvaVJOZ3dqNWxvdVNhdlpEUVptWDFKCk82em5UQVhBY21sVEpyUTJIdEhUSUNQdGhJWkF1K0Q4S3hqa0ZUb0UxRXM0VFU4SjF6bnBTazgwTkpjQXA3cTkKcXVWS2Z3S0NBUUVBb1RWa2szejFBV0pYZzY1dHpVWG85N3FZd2pJd3M0WmpBbEhGd3IvK2VIT3ZLVFpBNXVmcwpvWERod3N2dE5hVU5aWnFQZTlPNnRLci9sZHdXd2tpWTVTaXgzRW9SSERCUXduRGc2V01WZm5naXpLWDJxVDVSCm0vODNXaTROWE5zQlo2OXRSSWlSUSt3VkF3YTJmQ3hLZmhnYXh6djMxSTVhcUd1YmFnaDRmSWpKMHpiV1psMU8KTHdqQmtoeEx6MlE3TGQzNWdVTDZKTUlLSUEvYUluZ1BaQ3MyYkovd2hObnV6S3Z1eUFTdWJRbWd0a2czRjYzSwpOR3NUZWhseWpFdlNhR0dOdW9qbm5ZbGlsNmxTcStZU05BR0Q0bk9IeUVadmQvQjNiOGJVSUpDZ1RyRUN3dE1LCit0MnZaOXVQdkEvZmxqQ29DcFNDbzVpWnpwTFNCSTg1UlFLQ0FRQll2U3MwamZzVExOUVZseHkrTWNxRmtJOFkKeHd0b3Fud09xalJPUldnWDhVamNPakUvWTMwUm1aTEVUOTVBbG5rNWNDQmxNWkNMdlFqNXZKNThJRG5adWRpZgpvY1NFVmRHSWJhQ0dUSGpWUTMwU0l3eXA1OFhZSGRIdjUvNFdsQTFPWldjRTBVMlYxS09LZ2h5TWVlM05FeHZaCmViMHRYaVRzMVM1cWdyU2xNNXB0OEQzcENrZnBjWk9QOGNheTJGdnJ5NWw5NXlVYWZnWGJ0bjVHVjNTOE03NnYKUXVwWUxYdWNtWmxKZzVpWGRISjBMYzk5OEhVcUxXZTJGSlFadmFGVkZIaS9zU1cwVmhEOHVXRUs2MHJGMFROSgpkZnk4TC9Ka0sxaDVwNmo5YSt2S2RIZHZ0SkR0TGdTd0lwU2RjRnpBVURNMTRUV2dJSFF0WUJQbjAwU1gKLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K"
  key_id.txt: "YWFkZWY5NTRlM2YxMTQyMDczZDUwODMxMDE3ZjE2Y2ViNThlYWVjOWIyNWE4MDcxMTQ1NjEyNzY0ZDNiMTMwOA=="
---
# Source: unitycatalog/templates/server/db-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "unity-catalog-unitycatalog-server-db"
  labels:
    helm.sh/chart: unitycatalog-0.0.1-pre.1
    app.kubernetes.io/version: "main"
    app.kubernetes.io/managed-by: "Helm"
    app.kubernetes.io/name: "unitycatalog"
    app.kubernetes.io/component: "server"
    app.kubernetes.io/instance: "unity-catalog"
  annotations:
    helm.sh/hook: pre-install
    helm.sh/resource-policy: "keep"
spec:
  accessModes: 
    - ReadWriteOnce
  resources:
    requests:
      storage: "1Gi"
