# Optimized Spark Connect Thin Client for JupyterHub
# This image is ~800MB instead of 2.19GB by avoiding full Spark binaries
# Based on jupyter/base-notebook with only necessary components

FROM jupyter/base-notebook:python-3.11

USER root

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    openjdk-11-jre-headless \
    && rm -rf /var/lib/apt/lists/*

USER ${NB_UID}

# Install JupyterLab and essential extensions
RUN pip install --no-cache-dir \
    jupyterlab==4.0.7 \
    jupyterhub==4.0.2 \
    jupyter-server \
    ipykernel

# Install Spark dependencies FIRST (required for Spark Connect)
RUN pip install --no-cache-dir \
    pyarrow>=11.0.0 \
    numpy \
    pandas

# Install Spark Connect client libraries (NO full Spark installation)
RUN pip install --no-cache-dir \
    pyspark==4.0.1 \
    grpcio-status

# Install S3 support for notebook persistence
RUN pip install --no-cache-dir \
    s3contents \
    s3fs

# Install optional but useful packages
RUN pip install --no-cache-dir \
    matplotlib \
    seaborn \
    plotly

# Verify installation
RUN python -c "import pyspark; print(f'PySpark {pyspark.__version__} installed')" && \
    python -c "import grpc_status; print('grpcio-status installed')" && \
    python -c "import jupyterlab; print(f'JupyterLab {jupyterlab.__version__} installed')"

WORKDIR /home/jovyan/work

# The Spark Connect server address will be provided via SPARK_REMOTE environment variable
# e.g., SPARK_REMOTE=sc://spark-connect-server-driver-svc:15002
